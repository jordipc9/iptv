<!DOCTYPE html>
<html>

<head>
  <title>TV3 HD</title>
  <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/tv3-apple-touch-icon-180x180.png">
  <!--
  CCMA <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/ccma-apple-touch-icon-180x180.png">
  324 <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/324-apple-touch-icon-180x180.png">
  esport3 <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/esport3-apple-touch-icon-180x180.png">
  c33 <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/33-apple-touch-icon-180x180.png">
  sx3 <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/sx3/favicons/apple-touch-icon.png">
  super3 <link rel="apple-touch-icon" href="https://statics.ccma.cat/img/favicons/super3-apple-touch-icon-180x180.png"> -->
  <style>
  body {background-color: black;}
  p    {color: black; align: center; font-family: sans-serif; font-size: 60pt}
  a    {color: white; align: center; font-family: sans-serif; font-size: 60pt}
  </style>

  videojs.Hls.xhr.beforeRequest = function (options) {
    /*
     * Modifications to requests that will affect every player.
     */

    let newUri = options.uri.includes('.ts') ? options.uri + "?q=test" : options.uri;

    return {
      ...options,
      uri: newUri };

  };



  let player = videojs("my-video", {responsive: true}, () => {
    console.log("Start");


    player.one("loadedmetadata", () => {

      let qualities = player.
      tech({ IWillNotUseThisInPlugins: true }).
      hls.representations();
  console.log('qualities',qualities);
      createButtonsQualities({
        class: "item",
        qualities: qualities,
        father: player.controlBar.el_ });


      player.play();

      // ---------------------------------------------- //

      function createAutoQualityButton(params) {
        let button = document.createElement("div");

        button.id = "auto";
        button.innerText = `Auto`;

        button.classList.add("selected");

        if (params && params.class) button.classList.add(params.class);

        button.addEventListener("click", () => {
          removeSelected(params);
          button.classList.add("selected");
          qualities.map(quality => quality.enabled(true));
        });

        return button;
      }

      function createButtonsQualities(params) {

        let contentMenu = document.createElement('div');
        let menu = document.createElement('div');
        let icon = document.createElement('div');

        let fullscreen = params.father.querySelector('.vjs-fullscreen-control');
        contentMenu.appendChild(icon);
        contentMenu.appendChild(menu);
        fullscreen.before(contentMenu);

        menu.classList.add('menu');
        icon.classList.add('icon', 'vjs-icon-cog');
        contentMenu.classList.add('contentMenu');

        let autoButton = createAutoQualityButton(params);

        menu.appendChild(autoButton);

        qualities.sort((a, b) => {
          return a.height > b.height ? 1 : 0;
        });

        qualities.map(quality => {
          let button = document.createElement("div");

          if (params && params.class) button.classList.add(params.class);

          button.id = `${quality.height}`;
          button.innerText = quality.height + "p";

          button.addEventListener("click", () => {
            resetQuality(params);
            button.classList.add("selected");
            quality.enabled(true);
          });

          menu.appendChild(button);
        });

        setInterval(() => {
          let auto = document.querySelector("#auto");
          current = player.
          tech({ IWillNotUseThisInPlugins: true }).
          hls.selectPlaylist().attributes.RESOLUTION.height;
          console.log(current);

          document.querySelector("#auto").innerHTML = auto.classList.contains(
          "selected") ?

          `Auto <span class='current'>${current}p</span>` :
          "Auto";
        }, 1000);


      }

      function removeSelected(params) {
        document.querySelector("#auto").classList.remove("selected");
        [...document.querySelectorAll(`.${params.class}`)].map(quality => {
          quality.classList.remove("selected");
        });
      }

      function resetQuality(params) {
        removeSelected(params);

        for (let quality of params.qualities) {
          quality.enabled(false);
        }
      }
    });
  });



</head>
<body>
  <video autoplay width="100%" controls>
    <source src="https://directes-tv-cat.ccma.cat/live-origin/tv3-hls/master.m3u8" type="application/x-mpegURL">
  </video>
  </ <br>
  <p><a href="https://www.ccma.cat/tv3/programacio/canal-tv3/"; target="_blank">Veure programaci&oacute;</a></p>
</body>

</html>
